<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>Facebook Feed | SocketIOSpring</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<style>
		*{
			padding:0px;
			margin: 0 auto;
			box-sizing: border-box;
		}
		.container{
			width: 500px;
		}
		div.post{
			background-color:#dadada;
			width:100%;
		}
		div#status{
			margin-bottom:40px;
		}
		#status textarea{
			margin-top:5px;
			width:100%;
		}
		#btnPost{
		}
		.header{
			background-color: #3e62a0;
			min-height: 50px;
			color:#fff;
		}
	</style>
</head>
<body>
	<div class="header">Facebook</div>
	<div class="container">
		
		<div id="status">
			<textarea id="statusText" placeholder="What's your mind?"></textarea>
			<button id="btnPost" class="pull-right btn btn-primary">Post</button>
		</div>
		<div id="posts"></div>
	</div>
	
	<script src="/static/js/socket.io/socket.io.js"></script>
    <script src="/static/js/jquery-1.7.2.min.js"></script>
    <script>
    	var username = "user00-" + Math.floor(Math.random()*100);
    	var Post = {};
    	
    	var socketServerUrl = `${location.protocol}//${location.hostname}:3000`;
   		var nspPost = `${socketServerUrl}/post`;
   		
		var socket =  io.connect(nspPost);
		
    	socket.on('connect', function(){
			console.log('connected to server', socket.id);
			$('button#btnPost').on('click', function(){
				socket.emit('new post', {username: username, text: $('#statusText').val()});
			});
		});   
    	
    	socket.on('all posts', function(datas){
    		var post = ``;
    		datas.forEach(function(data, index){
    			post += Post.render(data);
    		});
			$('div#posts').html(post);
    	});
    	
    	socket.on('new post', function(data){
    		var post = Post.render(data);
    		$('div#posts').prepend(post);
    	});
    	
    	socket.on('update like', function(like, id){
    		console.log(arguments);
			$(`#like${id}`).html(like);
    	});
    	
    	socket.on('removed post', function(id){
			$(`#${id}`).parent().remove();
    	});
    	
    	Post.render = function(data){
    		return `<div class="post">
						<h3>${data.username} : ${data.text}</h3>
						<button id="${data.id}" onClick="Post.like(this)" class="btn btn-primary"><span id="like${data.id}">${data.like}</span> Like</button>
						<button id="${data.id}" onClick="Post.remove(this)" class="btn btn-danger">Remove</button>
					</div>`;	
    	}
    	
    	Post.remove = function(button){
        	socket.emit('remove post', button.id);	
    	}
    	
    	Post.like = function(button){
    		socket.emit('like post', button.id);
    	}
    </script>
</body>
</html>